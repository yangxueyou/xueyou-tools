### 历史

- 环境配置难题：在我的机器可以跑，在他机器上不行？

- 虚拟机：资源占用多，冗余步骤多，启动慢

- Linux 容器：不是模拟一个完整的操作系统，而是对进程进行隔离，总之，容器有点像轻量级的虚拟机，能够提供虚拟化的环境，但是成本开销小得多。

- Docker：属于 Linux 容器的一种封装，提供简单易用的容器使用接口。它是目前最流行的 Linux 容器解决方案。

### 安装

百度一下？

验证是否安装成

```js
$ docker version
// 或者
$ docker info
```

Docker 是服务器----客户端架构。命令行运行 docker 命令的时候，`需要本机启动 Docker 服务`。

### image 文件

`只有通过这个文件，才能生成 Docker 容器`

```js
// 列出本机的所有 image 文件。
$ docker image ls

// 删除 image 文件
$ docker image rm [imageName]
```

image 仓库：https://hub.docker.com/

### 实例：hello world

`library/hello-world`是 `image` 文件在仓库里面的位置，其中`library`是 `image` 文件所在的组，`hello-world`是 `image`文件的名字。

```js
// 这个具体什么命令下载可以在官网右上方看到
$ docker image pull hello-world
```

运行这个 image 文件,输出一段提示以后，hello world 就会停止运行，容器自动终止。

```js
$ docker container run hello-world
```

有些容器不会自动终止，因为提供的是服务。比如，安装运行 Ubuntu 的 image，就可以在命令行体验 Ubuntu 系统。

```js
$ docker container run -it ubuntu bash
```

对于那些不会自动终止的容器，必须使用 docker container kill 命令手动终止。

```js
$ docker container kill [containID]
```

### 容器文件

`image 文件生成的容器实例，本身也是一个文件，称为容器文件`也就是说，一旦容器生成，就会同时存在两个文件： image 文件和容器文件。而且关闭容器并不会删除容器文件，只是容器停止运行而已。

```js
// 列出本机正在运行的容器
$ docker container ls

// 列出本机所有容器，包括终止运行的容器
$ docker container ls --all
```

终止运行的容器文件(docker container kill)，依然会占据硬盘空间，可以使用 docker container rm 命令删除。

```js
$ docker container rm [containerID]
```

### Dockerfile

如何可以生成 image 文件？

这就需要用到 Dockerfile 文件。它是一个文本文件，用来配置 image。Docker 根据 该文件生成二进制的 image 文件。

### 实例：制作自己的 Docker 容器

TODO: 这个例子有点老，有时间弄一个新的，只为说明整体流程

- 作为准备工作，请先下载源码。

```js
$ git clone https://github.com/ruanyf/koa-demos.git
$ cd koa-demos
```

- 在项目的根目录下，新建一个文本文件.dockerignore

这三个路径要排除，不要打包进入 image 文件。如果你没有路径要排除，这个文件可以不新建。

```js
.git
node_modules
npm-debug.log
```

- 在项目的根目录下，新建一个文本文件 Dockerfile

```js
FROM node:8.4 // 该 image 文件继承官方的 node image，冒号表示标签，这里标签是8.4，即8.4版本的 node。
COPY . /app   // 将当前目录下的所有文件（除了.dockerignore排除的路径），都拷贝进入 image 文件的/app目录。
WORKDIR /app   // 指定接下来的工作路径为/app。
RUN npm install --registry=https://registry.npm.taobao.org  // 在/app目录下，运行npm install命令安装依赖。注意，安装后所有的依赖，都将打包进入 image 文件。
EXPOSE 3000 // 将容器 3000 端口暴露出来， 允许外部连接这个端口。
CMD node demos/01.js
```

```js
# Version 0.1
#
# # 基础镜像
 FROM ubuntu:latest
#
# # 维护者信息
 MAINTAINER wb-yxy494884@alibaba-inc.com
#
# # 镜像操作命令
 RUN apt-get -yqq update && apt-get install -yqq apache2 && apt-get clean
#
# # 容器启动命令
 CMD ["/usr/sbin/apache2ctl", "-D", "FOREGROUND"]
```

- 创建 image 文件

```js
$ docker image build -t koa-demo .  // 默认的标签就是latest
# 或者
$ docker image build -t koa-demo:0.0.1 .
```

```js
$ docker image ls
```

- 生成容器

`RUN`命令与`CMD`命令的区别在哪里？简单说，`RUN`命令在 `image` 文件的构建阶段执行，执行结果都会打包进入 `image` 文件；`CMD`命令则是在容器启动后执行。
另外，一个 `Dockerfile` 可以包含多个 RUN 命令，但是只能有`一个CMD`命令。

注意，指定了`CMD`命令以后，`docker container run`命令就不能附加命令了（比如/bin/bash），否则它会覆盖`CMD`命令。现在，启动容器可以使用下面的命令。

```js
docker container run --rm -p 8000:3000 -it koa-demo:0.0.1
```

- 发布 image 文件

```js
$ docker login
```

为本地的 image 标注用户名和版本。

```js
$ docker image tag [imageName] [username]/[repository]:[tag]
// 实例
$ docker image tag koa-demos:0.0.1 ruanyf/koa-demos:0.0.1
```

也可以不标注用户名，重新构建一下 image 文件。

```js
$ docker image build -t [username]/[repository]:[tag] .
```

发布 image 文件

```js
$ docker image push [username]/[repository]:[tag]
```

### 其他有用的命令

- `docker container start`

docker container run 命令是新建容器，每运行一次，就会新建一个容器，这个只是启动一个已有的

```js
docker container start [containerID]
```

- `docker container stop`

`docker container kill`命令终止容器运行，相当于向容器里面的主进程发出 `SIGKILL` 信号

`docker container stop`命令也是用来终止容器运行，相当于向容器里面的主进程发出 `SIGTERM` 信号，然后过一段时间再发出 `SIGKILL` 信号。

`SIGTERM` 信号，可以自行进行收尾清理工作，但也可以不理会这个信号。

`SIGKILL` 信号，就会强行立即终止，那些正在进行中的操作会全部丢失。

```js
$ docker container stop [containerID]
```

- `docker container logs`

如果`docker run`命令运行容器的时候，没有使用`-it参数`，就要用这个命令查看输出。

```js
$ docker container logs [containerID]
```

- `docker container exec`

如果`docker run`命令运行容器的时候，没有使用-it 参数，就要用这个命令进入容器

```js
$ docker container exec -it [containerID] /bin/bash
```

- `docker container cp`

`docker container cp`命令用于从正在运行的 `Docker` 容器里面，将文件拷贝到本机。下面是拷贝到当前目录的写法。

```js
$ docker container cp [containID]:[/path/to/file] .
```

### 容器的三剑客（wordpress）

TODO: 下面三种方法整理流程是没有问题的，但是端口，版本的影响可能不好使

#### 自建 WordPress 容器

跟上面使用 koa 差不多，只不过环境命令不一样，连接数据库等等，多了一大堆操作

#### Wordpress 官方镜像

首先，新建并启动 MySQL 容器。

```js
$ docker container run \
  -d \
  --rm \
  --name wordpressdb \
  --env MYSQL_ROOT_PASSWORD=123456 \
  --env MYSQL_DATABASE=wordpress \
  mysql:5.7
```

基于官方的 WordPress image，新建并启动 WordPress 容器。

```js
$ docker container run \
  -d \
  --rm \
  --name wordpress \
  --env WORDPRESS_DB_PASSWORD=123456 \
  --link wordpressdb:mysql \
  wordpress
```

WORDPRESS_DB_PASSWORD 是 MySQL 容器的根密码

#### Docker Compose

可以管理多个 Docker 容器组成一个应用。你需要定义一个 YAML 格式的配置文件 docker-compose.yml，写好多个容器之间的调用关系。然后，只要一个命令，就能同时启动/关闭这些容器

```js
// 启动所有服务
$ docker-compose up
// 关闭所有服务
$ docker-compose stop
```

```js
$ docker-compose --version
```

在 docker-demo 目录下，新建 docker-compose.yml 文件，写入下面的内容。

```js
mysql:
    image: mysql:5.7
    environment:
     - MYSQL_ROOT_PASSWORD=123456
     - MYSQL_DATABASE=wordpress
web:
    image: wordpress
    links:
     - mysql
    environment:
     - WORDPRESS_DB_PASSWORD=123456
    ports:
     - "127.0.0.3:8080:80"
    working_dir: /var/www/html
    volumes:
     - wordpress:/var/www/html
```

```js
$ docker-compose up

$ docker-compose stop

$ docker-compose rm // 把这两个容器文件删除（容器必须已经停止运行）。
```

### 参考

https://www.ruanyifeng.com/blog/2018/02/docker-tutorial.html

https://www.ruanyifeng.com/blog/2018/02/docker-wordpress-tutorial.html
