### 缺点

依赖冗余,用户访问流量提升,业务拆分粒度如果过细,会使整个架构复杂性提升,每个微应用为独立代码仓库,独立流水线,开发构建部署,需要团队基础设施资源是否足以支撑和扩展

### 优点

- 技术栈无关

主框架不限制接入应用的技术栈，微应用具备完全自主权

- 独立开发、独立部署

微应用仓库独立，前后端可独立开发，部署完成后主框架自动完成同步更新

- 增量升级

在面对各种复杂场景时，我们通常很难对一个已经存在的系统做全量的技术栈升级或重构，而微前端是一种非常好的实施渐进式重构的手段和策略

- 独立运行时

每个微应用之间状态隔离，运行时状态不共享

### 乾坤

> https://qiankun.umijs.org/zh/guide

下载官方代码

```js
// "qiankun": "^2.6.3"
$ git clone https://github.com/umijs/qiankun.git
```

正常根据官网的步骤就能启动 demo（也可能不好使哦）

#### 单机部署

使用上面官网的例子，我们进行简单的修改，然后进行部署，服务器上基本下面这结构

```js
├── main
│   └── index.html
└── subapp
    ├── react16
    │   └── index.html
    └── vue3
        └── index.html
```

下面主要讲一下主容器和 react16 这进行调整的注意事项

##### main

里面有两个下面这样的导入的，单拿出来会报错

```js
import {
  registerMicroApps,
  runAfterFirstMounted,
  setDefaultMountApp,
  start,
  initGlobalState,
} from "../../es";

import { loadMicroApp } from "../../es";
```

修复上面问题

```js
$ yarn add qiankun // 或者 npm i qiankun -S

import { registerMicroApps, runAfterFirstMounted, setDefaultMountApp, start, initGlobalState } from 'qiankun';

import { loadMicroApp } from 'qiankun';
```

在 package.json 中的 script 添加 build 命令

```js
"build": "cross-env NODE_ENV=production webpack"
```

webpack 添加插件

```js
// 好在js中使用process.env.NODE_ENV
const webpack = require("webpack");
new webpack.DefinePlugin({
  "process.env": {
    NODE_ENV: JSON.stringify(process.env.NODE_ENV),
  },
}),
```

修改 entry，区分本地和线上

```js
let entry =
  process.env.NODE_ENV === "production"
    ? "//47.98.102.106/subapp/react16"
    : "//localhost:7100";
```

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>QianKun Example</title>
  </head>

  <body>
    <div class="mainapp">
      <header class="mainapp-header">
        <h1>QianKun</h1>
      </header>
      <div class="mainapp-main">
        <ul class="mainapp-sidemenu">
          <li onclick="push('/react16')">React16</li>
          <li onclick="push('/vue3')">Vue3</li>
        </ul>
        <main id="subapp-container"></main>
      </div>
    </div>
    <script>
      function push(subapp) {
        history.pushState(null, subapp, subapp);
      }
    </script>
    <script type="text/javascript" src="/main.js"></script>
  </body>
</html>
```

##### react16

覆盖 webpack 配置，默认的变量替换不掉（可能以后就修复了）

```js
$ npm i react-app-rewired -D
```

```js
{
    "name": "react16",  // 和main中引用的名字一致
    "scripts": {
      "start": "react-app-rewired start",
      "build": "react-app-rewired build",
      "test": "react-app-rewired test --env=jsdom",
      "eject": "react-scripts eject"
    },
}
```

```js
// config-overrides.js
const { name } = require("./package.json");

module.exports = {
  webpack: function override(config, env) {
    config.entry = config.entry.filter(
      (e) => !e.includes("webpackHotDevClient")
    );

    config.output.library = `${name}-[name]`;
    config.output.libraryTarget = "umd";
    config.output.jsonpFunction = `webpackJsonp_${name}`;
    return config;
  },
  devServer: (configFunction) => {
    return function (proxy, allowedHost) {
      const config = configFunction(proxy, allowedHost);
      config.open = false;
      config.hot = false;
      config.headers = {
        "Access-Control-Allow-Origin": "*",
      };
      // Return your customised Webpack Development Server config.
      return config;
    };
  },
};
```

```js
// .env
// 这个路径对应的服务器部署的路径
PUBLIC_URL=/subapp/react16
```

```html
<link href="/subapp/react16/favicon.ico" rel="icon" />
```

##### nginx 配置

```js
// 默认 /etc/nginx/conf.d/default.conf
server {
  listen       80;
  server_name 47.98.102.106;
  location / {
    root   /usr/share/nginx/html/main;  // 主应用所在的目录
    index index.html;
    try_files $uri $uri/ /index.html;
  }
  location /subapp {
    alias /usr/share/nginx/html/subapp;
    try_files $uri $uri/ /index.html;
  }
}
```

##### 参考

https://juejin.cn/post/6875462470593904653


#### 源码分析

https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzA3NTk4NjQ1OQ==&action=getalbum&album_id=2251416802327232513&scene=173&from_msgid=2247484426&from_itemidx=1&count=3&nolastread=1#wechat_redirect